# =============================================================================
# Tier 3: Generated Services (TaskTracker Application)
# =============================================================================
# Part of the 5-file compose merge architecture:
#   Tier 0: docker-compose.infra.yml      (postgres, redis)
#   Tier 1: docker-compose.build1.yml     (architect, contract-engine, codebase-intel)
#   Tier 2: docker-compose.traefik.yml    (traefik reverse proxy)
#   Tier 3: docker-compose.generated.yml  (THIS FILE)
#   Tier 4: docker-compose.run4.yml       (overrides, labels, debug logging)
#
# Three Python/FastAPI microservices generated by the builder fleet:
#   - auth-service:         User registration, login, JWT issuance
#   - order-service:        Order CRUD, JWT validation, event publishing
#   - notification-service: Event consumption, notification delivery
#
# All services listen on internal port 8080 with dynamic external ports.
# Memory budget: 3 x 768m = 2.3GB (within 4.5GB total system budget).
# =============================================================================

services:

  # ---------------------------------------------------------------------------
  # auth-service: Identity provider, standalone (depends only on postgres)
  # ---------------------------------------------------------------------------
  auth-service:
    build:
      context: ../generated/auth-service
      dockerfile: Dockerfile
    ports:
      - "8080"
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/auth_db
      - JWT_SECRET=${JWT_SECRET:-super-team-dev-secret}
      - LOG_LEVEL=info
      - SERVICE_NAME=auth-service
    networks:
      - frontend
      - backend
    deploy:
      resources:
        limits:
          memory: 768m
    mem_limit: 768m
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth-service.rule=PathPrefix(`/api/auth`)"
      - "traefik.http.routers.auth-service.entrypoints=web"
      - "traefik.http.services.auth-service.loadbalancer.server.port=8080"

  # ---------------------------------------------------------------------------
  # order-service: Order management, validates JWT from auth-service
  # ---------------------------------------------------------------------------
  order-service:
    build:
      context: ../generated/order-service
      dockerfile: Dockerfile
    ports:
      - "8080"
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/order_db
      - JWT_SECRET=${JWT_SECRET:-super-team-dev-secret}
      - AUTH_SERVICE_URL=http://auth-service:8080
      - LOG_LEVEL=info
      - SERVICE_NAME=order-service
    networks:
      - frontend
      - backend
    deploy:
      resources:
        limits:
          memory: 768m
    mem_limit: 768m
    restart: unless-stopped
    depends_on:
      auth-service:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.order-service.rule=PathPrefix(`/api/orders`)"
      - "traefik.http.routers.order-service.entrypoints=web"
      - "traefik.http.services.order-service.loadbalancer.server.port=8080"

  # ---------------------------------------------------------------------------
  # notification-service: Event consumer, depends on order-service + redis
  # ---------------------------------------------------------------------------
  notification-service:
    build:
      context: ../generated/notification-service
      dockerfile: Dockerfile
    ports:
      - "8080"
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/notification_db
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET:-super-team-dev-secret}
      - AUTH_SERVICE_URL=http://auth-service:8080
      - LOG_LEVEL=info
      - SERVICE_NAME=notification-service
    networks:
      - frontend
      - backend
    deploy:
      resources:
        limits:
          memory: 768m
    mem_limit: 768m
    restart: unless-stopped
    depends_on:
      order-service:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.notification-service.rule=PathPrefix(`/api/notifications`)"
      - "traefik.http.routers.notification-service.entrypoints=web"
      - "traefik.http.services.notification-service.loadbalancer.server.port=8080"

networks:
  frontend:
    external: true
  backend:
    external: true
